# 数据字典解决方案

## 需求和问题

1. 字典表在数据库里面管理, 字典表可以由页面进行配置配置.
2. 字典表是需要可配置的, 因此代码里面不能够有任何字典项信息, 那么字典表和代码衔接问题需要解决.
3. 前后台接收发送数据字典的方式.

## 设计思路

1. 要想使用数据库管理字典表首先需要建立字典表, 建立两张表, 一张管理字典类型信息, 一张管理字典项信息, 字典类型表和字典表为一对多关系.
2. 字典表的使用需要和字段结合起来, 那么就需要字段表以便于配置字段和字典表的信息(如果不使用字段表的话, 那么只能在代码里面直接去使用字典的键去获取字典, 那么就不能够做到字典的配置, 只能够做到字典项配置. 这样的话字典类型势必会对代码造成侵入性, 不方便后续扩展和管理).
3. 数据字典结合做成可配置式, 需要用到字段表, 字典类型表, 字典项表, 字段表确立字段和字典类型的关系, 这样就可以实现前台页面增删改查管理配置数据字典.
4. 代码里面肯定会需要用到字典表数据, 而字典表是需要可配置的, 因此代码里面不能够有任何字典项信息, 在此通过枚举来管理数据字典, 这样还可以避免魔法值问题.
5. 代码里面使用枚举会有很多问题, 在此使用解决方案 -> [巧用枚举让字典表的管理和使用变得简单, 优雅](https://blog.csdn.net/u011511756/article/details/88094754)
6. 代码里面无可避免会使用数据字典, 数据字典页面配置改变后, 项目里面可能会受到影响, 在此字典项表里面加入字段来判断当前数据字典是否在被代码使用, 如果在使用配置时则弹出提示信息. 
7. 数据字典配置后, 代码里面的枚举也需要改变, 如果使用人工编写枚举的话, 很容易造成失误, 而且特别麻烦, 在此采用velocity模型实时一键生成枚举, 实现数据字典和代码的良好衔接.
8. 数据字典增删改次数少, 但查询次数巨大, 可以更改表引擎为MyISam和采用redis缓存来提高访问速度.
9. 数据字典项表加入中英文标签, 支持中英文切换.
10. 后台提供字典表获取统一接口, 前台提供字典表统一查询方法.

> 遗留问题
>
> 1. 字典表配置更新后, 已经打开的页面来不及更新枚举
>
>     没什么好的方法, 设计好一点, 尽量在很少人使用的时候修改, 实在不行, 修改后后台直接报错, 或前台页面提示或刷新. 甚至修改时直接抛出个维护中的页面.
>
> 2. 字典表配置更新后, 用到该枚举的表字段数据该如何解决.
>
>     手动更改数据库吧
>

## 优点

1. 数据字典可以由前台页面进行配置式管理.
2. 使用枚举在开发时非常方便. 实现和数据库字典的衔接.
3. 一键生成枚举实现开发时实时更新.
4. 加入中英文标签, 实现中英文切换.

## 详细

1. 页面初始化加载枚举
   1. 扫描当前页面是否有使用到枚举的地方, 有则提供枚举id, 到后台查询枚举id
   2. 若页面有页面枚举配置, 则到后台查询配置, 之后解析出枚举
   3. 后台接收之后到缓存中获取枚举
   4. 将枚举传到前台. 前台提供保存字典表方法.
2. 全局加载枚举
   1. 需要枚举时先在浏览器里面寻找, 需要配合config_id使用.

## 缓存

1. 以页面标识作为hkey做字典数据缓存.
2. 以字典类型作为hkey做字典表缓存.

## 数据字典表设计

1. 前后台交互, 前台传送字典参数时肯定传送字典类型和字典项, 总不能传送个guid吧, 这样guid就显得没什么用处了.
2. 字典项和字典类型两个应该唯一, 设计成一个联合主键, 使用联合主键查询更快更方便.
3. 在没有guid的情况下, 主键不能随便变动, 设置一个外键以防止这种情况, 并且防止脏数据.
4. 数据字典增删改次数少, 但查询次数巨大, 而且字典表只有管理员去进行更改, 可以更改表引擎为MyISam.

数据字典表 sql 如下

```sql
CREATE TABLE `sys_dict_item` (
    `type` varchar(50) NOT NULL COMMENT '字典类别',
    `value` varchar(20) NOT NULL COMMENT '值',
    `name` varchar(50) not null comment '枚举的name, 作为字典项的识别标志, 在代码里面作为枚举标识使用, 无论字典如何配置, name不变, 一个枚举类型里面name唯一',
    `en_label` varchar(50) NOT NULL COMMENT '英文标签',
    `cn_label` varchar(50) NOT NULL COMMENT '中文标签',
    `p_value` varchar(12) NOT NULL DEFAULT '' COMMENT '父ID, 多级字典表时有用',
    `level` int(1) NOT NULL comment '层级, 当前字典项的层级, 多级字典表时有用',
    `sort` int(3) NOT NULL DEFAULT '50' COMMENT '顺序, 字典项显示的顺序',
    `comment` varchar(400) NOT NULL DEFAULT '' COMMENT '数据描述',
    `add_time` datetime NOT NULL COMMENT '添加时间',
    `update_time` datetime NOT NULL COMMENT '更新时间',
    `state` char(1) NOT NULL COMMENT 'y正常,n删除',
    PRIMARY KEY (`type`,`value`),
    constraint type
       foreign key (type) references sys_dict_type (name)
          on update cascade
)  DEFAULT CHARSET=utf8 COMMENT='系统字典项表';

CREATE TABLE `sys_dict_type` (
    `name` varchar(50) NOT NULL COMMENT '字典名称, 唯一标识, sys_dict_item关联字段, 不能顺便更改',
    `text` varchar(200) NOT NULL COMMENT '显示名称',
    `type` varchar(10) not null comment '字典类型',
    `sort` int(3) NOT NULL DEFAULT '50' COMMENT '顺序',
    `max_level` int(1) NOT NULL comment '最大级别',
    `comment` varchar(400) NOT NULL DEFAULT '' COMMENT '数据描述',
    `add_time` datetime NOT NULL COMMENT '添加时间',
    `update_time` datetime NOT NULL COMMENT '更新时间',
    `state` char(1) NOT NULL COMMENT 'y正常,n删除'
) DEFAULT CHARSET=utf8 COMMENT='系统字典表';

```

```sql
INSERT INTO `sys_dict_item` (`type`, `value`, `en_label`, `cn_label`, `p_value`, `sort`, `level`, `comment`, `add_time`, `update_time`, `state`)
VALUES
('sys_dict_type_package', 'bns',       'business',    '业务类', '', '50', '1', '', now(), now(), 'y'),
('sys_dict_type_package', 'com',       'common',      '通用类', '', '50', '1', '', now(), now(), 'y'),
('sys_dict_type_package', 'sys',       'system',      '系统类', '', '50', '1', '', now(), now(), 'y'),
('table_state',           'n',         'disable',     '禁用', '', '50', '1', '', now(), now(), 'y'),
('table_state',           'y',         'enable',      '可用', '', '50', '1', '', now(), now(), 'y'),
('control_type',                 'text',      'text',        '文本输入框', '', '50', '1', '', now(), now(), 'y'),
('control_type',              'text_area', 'text_area',   '文本域', '', '50', '1', '', now(), now(), 'y'),
('control_type',           'number',    'number',      '数字输入框', '', '50', '1', '', now(), now(), 'y'),
('control_type',           'Radio',     'Radio',       '单选按钮组', '', '50', '1', '', now(), now(), 'y'),
('control_type',           'checkbox',  'checkbox',    '复选按钮组', '', '50', '1', '', now(), now(), 'y'),
('control_type',           'select',    'select',      '下拉框', '', '50', '1', '', now(), now(), 'y'),
('control_type',           'multi_select','multi_select','多选下拉框', '', '50', '1', '', now(), now(), 'y'),
('control_type',           'show',      'show',        '普通显示框', '', '50', '1', '', now(), now(), 'y');


INSERT INTO `sys_dict_type` (`name`, `text`, `type`, `sort`, `max_level`, `comment`, `add_time`, `update_time`, `state`)
VALUES
('sys_dict_type_package',  '字典类型包', 'sys', '0', '1', '字典类型的包, 便于区分字典类型, 系统固有数据', now(), now(), 'y'),
('table_state',            '状态',       'com', '0', '1', '数据表的状态字段, 判断数据状态类型',          now(), now(), 'y'),
('control_type',           '控件类型',   'sys', '0', '1', '控件类型, 生成前端代码或前端交互时使用',          now(), now(), 'y');

```

